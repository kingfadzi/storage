events {}

http {
    server {
        listen 8000;
        server_name _;

        # Affine configuration
        location / {
            proxy_pass http://host.docker.internal:3010;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

    # Main proxy block for Superset under /analytics/
     location ^~ /analytics/ {
         # Remove the /analytics prefix before passing to the upstream
         rewrite ^/analytics/(.*)$ /$1?$args break;
         # Proxy to Superset on host.docker.internal:8099
         proxy_pass http://host.docker.internal:8099;

         # Sub_filter settings to rewrite upstream absolute URLs so they include /analytics
         sub_filter_types *;
         sub_filter_once off;

         sub_filter '/api/v1/'                   '/analytics/api/v1/';
         sub_filter 'api/v1/'                     '/analytics/api/v1/';
         sub_filter '/dynamic-plugins/'           '/analytics/dynamic-plugins/';
         sub_filter 'dynamic-plugins/'            '/analytics/dynamic-plugins/';

         sub_filter '/login/'                     '/analytics/login/';
         sub_filter '/superset/'                  '/analytics/superset/';

         sub_filter '/static/assets/'             '/analytics/static/assets/';
         sub_filter '/static/appbuilder/'         '/analytics/static/appbuilder/';

         sub_filter '/dashboard/'                 '/analytics/dashboard/';
         sub_filter '/dashboardasync/'            '/analytics/dashboardasync/';
         sub_filter '/chart/'                     '/analytics/chart/';
         sub_filter '/users/'                     '/analytics/users/';
         sub_filter '/lang/'                      '/analytics/lang/';
         sub_filter '/roles/'                     '/analytics/roles/';
         sub_filter '/logout/'                    '/analytics/logout/';
         sub_filter '/login'                      '/analytics/login';  # no trailing slash
         sub_filter '/explore/'                   '/analytics/explore/';
         sub_filter '/alert/'                     '/analytics/alert/';

         sub_filter '/tabstateview/'              '/analytics/tabstateview/';
         sub_filter '/savedqueryview/'            '/analytics/savedqueryview/';
         sub_filter '/savedqueryviewapi/'         '/analytics/savedqueryviewapi/';
         sub_filter '/databaseview/'              '/analytics/databaseview/';
         sub_filter '/tablemodelview/'            '/analytics/tablemodelview/';
         sub_filter '/rowlevelsecurityfiltersmodelview/' '/analytics/rowlevelsecurityfiltersmodelview/';
         sub_filter '/logmodelview/'              '/analytics/logmodelview/';
         sub_filter '/annotationlayermodelview/'  '/analytics/annotationlayermodelview/';
         sub_filter '/csstemplatemodelview/'      '/analytics/csstemplatemodelview/';
         sub_filter '/csstemplateasyncmodelview/' '/analytics/csstemplateasyncmodelview/';
         sub_filter '/tableschemaview/'           '/analytics/tableschemaview/';
         sub_filter '/csvtodatabaseview/'         '/analytics/csvtodatabaseview/';
         sub_filter '/columnartodatabaseview/'    '/analytics/columnartodatabaseview/';
         sub_filter '/exceltodatabaseview/'       '/analytics/exceltodatabaseview/';
         sub_filter '/annotationmodelview/'       '/analytics/annotationmodelview/';

         sub_filter '/dataset/'                   '/analytics/dataset/';
         sub_filter '/oidc_callback'              '/analytics/oidc_callback';
         sub_filter '/superset/dashboard/'        '/analytics/superset/dashboard/';

         sub_filter 'href="/back"'                'href="/analytics/back"';

         # Rewrite upstream redirects to include /analytics and the proper port
         proxy_redirect 'http://$host/' '/analytics/';

         # Disable compression so that sub_filter works correctly
         proxy_set_header Accept-Encoding "";
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     }

     # Redirect /superset/login to use /analytics
     location /superset/login {
         proxy_set_header Accept-Encoding "";
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         return 301 http://localhost:8080/analytics/superset/login;
     }

     # Handle /superset/dashboard/{id}/ with a conditional rewrite
     location ~ ^/superset/dashboard/(\d+)/ {
         if ($arg_edit = true) {
             rewrite ^/superset/dashboard/(\d+)/ /analytics/superset/dashboard/$1/ permanent;
         }
     }

    }
}
